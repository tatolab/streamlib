[package]
name = "streamlib"
version.workspace = true
edition.workspace = true
authors.workspace = true
license.workspace = true
repository.workspace = true
description = "Real-time streaming infrastructure for AI agents - unified crate"
keywords = ["video", "streaming", "gpu", "real-time", "ai"]
categories = ["multimedia::video", "multimedia", "api-bindings"]

[lib]
name = "streamlib"
# cdylib: Python extension module (when python feature enabled)
# rlib: Rust library (default)
crate-type = ["rlib", "cdylib"]

[features]
default = []

# Debug overlay with FPS, GPU memory, and performance graph
debug-overlay = ["dep:vello", "dep:skrifa", "dep:wgpu-profiler"]

# MCP server for AI agent integration
mcp = [
    "dep:rmcp",
    "dep:async-trait",
    "dep:schemars",
    "dep:clap",
    "dep:axum",
]

# Python bindings via PyO3 (extension module mode - for .so/.dylib built with maturin)
python = [
    "dep:pyo3",
    "pyo3/extension-module",
    "dep:unindent",
]

# Python embedding (for binaries like MCP server that execute Python code)
python-embed = [
    "dep:pyo3",
    "pyo3/auto-initialize",
    "dep:unindent",
]

[dependencies]
# Procedural macros
streamlib-macros = { path = "../streamlib-macros" }

# Core dependencies (always included)
thiserror.workspace = true
anyhow.workspace = true
tracing.workspace = true
tracing-subscriber = "0.3"  # For MCP binary logging
tokio.workspace = true
crossbeam-channel = "0.5"
inventory = "0.3"
parking_lot = "0.12"  # Fast mutexes for all synchronization
rtrb = "0.3.2"  # Lock-free SPSC ring buffer for real-time audio/video
signal-hook = "0.3"  # Native signal handling (SIGTERM, SIGINT) for event bus
ctrlc = "3.4"  # Cross-platform Ctrl+C handler (works with GUI apps)
dashmap = "6.1"  # Lock-free concurrent HashMap for event bus topic routing
rayon = "1.10"  # Parallel task execution for event bus dispatch

# Serialization
serde.workspace = true
serde_json.workspace = true
serde_yaml.workspace = true

# WebGPU for cross-platform GPU abstraction
wgpu.workspace = true

# CLAP audio plugin hosting (core dependency, like wgpu)
clack-host = { git = "https://github.com/prokopyl/clack" }
clack-extensions = { git = "https://github.com/prokopyl/clack", features = ["clack-host", "params"] }

# Audio resampling for real-time safe sample rate conversion
rubato = "0.16"

dasp = { version = "0.11", features = ["signal", "slice"] }
dasp_signal = { version = "0.11", features = ["bus"] }

# WebRTC streaming dependencies (using webrtc-rs)
webrtc = "0.14.0"  # Full-featured WebRTC implementation
bytes = "1.5"      # Zero-copy byte buffers for RTP samples
fastrand = "2.0"   # Fast PRNG for RTP timestamp base
local-ip-address = "0.6"  # Network interface enumeration for ICE candidates

# HTTP client for WHIP signaling (reuses existing hyper from workspace)
hyper = { workspace = true }  # HTTP client core
hyper-rustls = { version = "0.27", features = ["http2", "native-tokio", "ring"] }  # TLS support (ring for crypto)
hyper-util = { version = "0.1", features = ["client", "client-legacy", "http1", "http2", "tokio"] }  # HTTP client utilities
http-body-util = "0.1"  # Body handling utilities
rustls = { version = "0.23", features = ["ring"] }  # TLS library with ring crypto provider

# Optional: Debug overlay dependencies
vello = { git = "https://github.com/linebender/vello", rev = "5e3e12559781891b204553161aee761900c7e92d", optional = true }
skrifa = { version = "0.22", optional = true }
wgpu-profiler = { version = "0.23.0", optional = true }

# Optional: MCP dependencies
rmcp = { version = "0.8", features = ["server", "transport-io", "transport-streamable-http-server"], optional = true }
async-trait = { version = "0.1", optional = true }
schemars = { version = "1.0", optional = true }
clap = { version = "4.5", features = ["derive"], optional = true }
axum = { workspace = true, optional = true }

# Optional: Python dependencies
# Note: Use "extension-module" for building .so/.dylib (maturin build)
#       Use "auto-initialize" for embedding Python in binaries (MCP server)
pyo3 = { version = "0.22", features = ["abi3-py310"], optional = true }
unindent = { version = "0.2", optional = true }

# Platform-specific: macOS/iOS
[target.'cfg(any(target_os = "macos", target_os = "ios"))'.dependencies]
objc2.workspace = true
objc2-metal.workspace = true
objc2-io-surface.workspace = true
objc2-core-video.workspace = true
objc2-foundation.workspace = true
objc2-av-foundation = { workspace = true, features = ["objc2-core-media", "objc2-core-video"] }
objc2-core-media.workspace = true
objc2-app-kit.workspace = true
objc2-quartz-core.workspace = true
objc2-core-text.workspace = true
objc2-core-graphics.workspace = true
libc.workspace = true

# Apple-specific crates
metal = "0.31"  # Metal crate for wgpu-hal interop
dispatch2 = "0.3"  # GCD dispatch queues
# yuv.workspace = true  # REMOVED - now using GPU-accelerated VTPixelTransferSession
pollster = "0.3"  # For blocking on async
cpal = "0.15"  # Cross-platform audio I/O (uses CoreAudio on macOS)
mach2 = "0.4"  # Mach kernel API for thread priorities and timing
opus = "0.3"  # Opus audio codec encoder/decoder

[target.'cfg(target_os = "macos")'.dependencies]
core-foundation = "0.9"
core-graphics = "0.24"

[dev-dependencies]
tokio = { workspace = true, features = ["full"] }
hound = "3.5"  # WAV file writing for examples
criterion = "0.5"  # Benchmarking framework
rustls = { version = "0.23", features = ["ring"] }  # For WHIP test crypto provider

[[bench]]
name = "connection_bench"
harness = false

[[bench]]
name = "phase2_bench"
harness = false

[[bench]]
name = "event_bus_bench"
harness = false

[[bench]]
name = "stream_output_bench"
harness = false

[package.metadata.docs.rs]
# Generate docs for all platforms and features
all-features = true
targets = ["x86_64-apple-darwin", "x86_64-unknown-linux-gnu", "x86_64-pc-windows-msvc"]

# MCP Server Binary
[[bin]]
name = "streamlib-mcp"
path = "src/bin/streamlib-mcp.rs"
required-features = ["mcp"]
