[package]
name = "streamlib"
version.workspace = true
edition.workspace = true
authors.workspace = true
license-file.workspace = true
repository.workspace = true
description = "Real-time streaming infrastructure for AI agents - unified crate"
keywords = ["video", "streaming", "gpu", "real-time", "ai"]
categories = ["multimedia::video", "multimedia", "api-bindings"]

[lib]
name = "streamlib"
crate-type = ["rlib"]

[features]
default = []
# GPU backend selection (feature overrides default platform backend)
backend-metal = []
backend-vulkan = ["dep:ash"]
# FFmpeg-based encoding/decoding (Linux)
ffmpeg = []

[dependencies]
# Execution types (shared with macros for code generation)
streamlib-codegen-shared = { path = "../streamlib-codegen-shared" }

# Procedural macros
streamlib-macros = { path = "../streamlib-macros" }

# Core dependencies (always included)
thiserror.workspace = true
anyhow.workspace = true
tracing.workspace = true
tracing-subscriber = "0.3"
tokio = { workspace = true, features = ["rt-multi-thread", "net", "sync"] }
crossbeam-channel = "0.5"
inventory = "0.3"
parking_lot = "0.12"  # Fast mutexes for all synchronization
rtrb = "0.3.2"  # Lock-free SPSC ring buffer for real-time audio/video
iceoryx2 = "0.8.1"  # Zero-copy IPC pub/sub for cross-process communication
rmp-serde = "1.3"  # MessagePack serialization for frame payloads
signal-hook = "0.3"  # Native signal handling (SIGTERM, SIGINT) for event bus
ctrlc = "3.4"  # Cross-platform Ctrl+C handler (works with GUI apps)
dashmap = "6.1"  # Lock-free concurrent HashMap for event bus topic routing
rayon = "1.10"  # Parallel task execution for event bus dispatch
petgraph = "0.8.3"  # Directed graph for GraphOptimizer topology analysis
ahash = "0.8"  # Fast hashing for graph checksum computation
anymap2 = "0.13"  # TypeMap for embedded component storage on graph weights
cuid2 = "0.1"  # Collision-resistant unique identifiers for processor/link IDs
dirs = "6.0"   # Cross-platform home directory resolution

# Serialization
serde.workspace = true
serde_json.workspace = true
serde_yaml.workspace = true
toml.workspace = true
schemars = "0.8"  # JSON Schema generation from Rust types

# CLAP audio plugin hosting
clack-host = { git = "https://github.com/prokopyl/clack" }
clack-extensions = { git = "https://github.com/prokopyl/clack", features = ["clack-host", "params"] }

# Audio resampling for real-time safe sample rate conversion
rubato = "0.16"

# Vulkan backend (optional, enabled via backend-vulkan feature)
ash = { version = "0.38", default-features = false, features = ["std", "loaded"], optional = true }

dasp = { version = "0.11", features = ["signal", "slice"] }
dasp_signal = { version = "0.11", features = ["bus"] }

# WebRTC streaming dependencies (using webrtc-rs)
webrtc = "0.14.0"  # Full-featured WebRTC implementation
bytes = "1.5"      # Zero-copy byte buffers for RTP samples
fastrand = "2.0"   # Fast PRNG for RTP timestamp base
local-ip-address = "0.6"  # Network interface enumeration for ICE candidates

# HTTP client for WHIP signaling (reuses existing hyper from workspace)
hyper = { workspace = true }  # HTTP client core
hyper-rustls = { version = "0.27", features = ["http2", "native-tokio", "ring"] }  # TLS support (ring for crypto)
hyper-util = { version = "0.1", features = ["client", "client-legacy", "http1", "http2", "tokio"] }  # HTTP client utilities
http-body-util = "0.1"  # Body handling utilities
rustls = { version = "0.23", features = ["ring"] }  # TLS library with ring crypto provider

axum.workspace = true
tower-http = { version = "0.6", features = ["trace"] }  # HTTP request/response logging middleware
futures-util = "0.3"  # For StreamExt/SinkExt on WebSocket

# OpenAPI documentation generation
utoipa = { version = "5.3", features = ["axum_extras"] }
utoipa-axum = "0.2"

# Platform-specific: macOS/iOS
[target.'cfg(any(target_os = "macos", target_os = "ios"))'.dependencies]
objc2.workspace = true
objc2-metal.workspace = true
objc2-io-surface.workspace = true
objc2-core-foundation.workspace = true
objc2-core-video.workspace = true
objc2-foundation.workspace = true
objc2-av-foundation = { workspace = true, features = ["objc2-core-media", "objc2-core-video"] }
objc2-core-media.workspace = true
objc2-app-kit.workspace = true
objc2-quartz-core.workspace = true
objc2-core-text.workspace = true
objc2-core-graphics.workspace = true
libc.workspace = true

# Apple-specific crates
metal = "0.31"  # Metal crate for native RHI backend
dispatch2 = "0.3"  # GCD dispatch queues
# yuv.workspace = true  # REMOVED - now using GPU-accelerated VTPixelTransferSession
pollster = "0.3"  # For blocking on async
cpal = "0.15"  # Cross-platform audio I/O (uses CoreAudio on macOS)
mach2 = "0.4"  # Mach kernel API for thread priorities and timing
opus = "0.3"  # Opus audio codec encoder/decoder
launchd = "0.3"  # Launchd plist generation for broker service
ctor = "0.4"  # Global constructor for automatic broker mode detection
tonic = "0.12"  # gRPC client for broker availability check
prost = "0.13"  # Protocol Buffers for gRPC message types
streamlib-broker = { path = "../streamlib-broker" }  # Broker proto types for gRPC client

[target.'cfg(target_os = "macos")'.dependencies]
core-foundation = "0.9"
core-graphics = "0.24"

[dev-dependencies]
tokio = { workspace = true, features = ["full"] }
hound = "3.5"  # WAV file writing for examples
rustls = { version = "0.23", features = ["ring"] }  # For WHIP test crypto provider
serial_test = "3.2"  # Run tests sequentially to avoid global PUBSUB interference
tempfile = "3.14"  # Temporary directories for config tests

# Build dependencies for protobuf compilation (broker gRPC)
[target.'cfg(target_os = "macos")'.build-dependencies]
tonic-build = "0.12"
prost-build = "0.13"

[package.metadata.docs.rs]
# Generate docs for all platforms and features
all-features = true
targets = ["x86_64-apple-darwin", "x86_64-unknown-linux-gnu", "x86_64-pc-windows-msvc"]

[package.metadata.streamlib]
# Data type schemas (JTD format)
schemas = [
    "schemas/com.tatolab.videoframe.yaml",
    "schemas/com.tatolab.audioframe.1ch.yaml",
    "schemas/com.tatolab.audioframe.2ch.yaml",
    "schemas/com.tatolab.audioframe.3ch.yaml",
    "schemas/com.tatolab.audioframe.4ch.yaml",
    "schemas/com.tatolab.audioframe.5ch.yaml",
    "schemas/com.tatolab.audioframe.6ch.yaml",
    "schemas/com.tatolab.audioframe.7ch.yaml",
    "schemas/com.tatolab.audioframe.8ch.yaml",
    # Config schemas (JTD format)
    "schemas/com.streamlib.api_server.config@1.0.0.yaml",
    "schemas/com.streamlib.clap.effect.config@1.0.0.yaml",
    "schemas/com.tatolab.audio_channel_converter.config@1.0.0.yaml",
    "schemas/com.tatolab.audio_mixer.config@1.0.0.yaml",
    "schemas/com.tatolab.audio_resampler.config@1.0.0.yaml",
    "schemas/com.tatolab.buffer_rechunker.config@1.0.0.yaml",
    "schemas/com.tatolab.camera.config@1.0.0.yaml",
    "schemas/com.tatolab.chord_generator.config@1.0.0.yaml",
    "schemas/com.tatolab.display.config@1.0.0.yaml",
    "schemas/com.tatolab.simple_passthrough.config@1.0.0.yaml",
]

# Processor schemas (co-located with Rust source)
processors = [
    "src/apple/processors/camera.yaml",
    "src/apple/processors/display.yaml",
    "src/core/processors/api_server.yaml",
    "src/core/processors/audio_channel_converter.yaml",
    "src/core/processors/audio_mixer.yaml",
    "src/core/processors/audio_resampler_1ch.yaml",
    "src/core/processors/audio_resampler_2ch.yaml",
    "src/core/processors/buffer_rechunker_1ch.yaml",
    "src/core/processors/buffer_rechunker_2ch.yaml",
    "src/core/processors/chord_generator.yaml",
    "src/core/processors/clap_effect.yaml",
    "src/core/processors/simple_passthrough.yaml",
]

# MCP Server Binary removed - needs redesign for Phase 1
# [[bin]]
# name = "streamlib-mcp"
# path = "src/bin/streamlib-mcp.rs"
# required-features = ["mcp"]
