# Processor Macro Migration Assessment

## Executive Summary

Assessed all processors in both `core` and `apple` implementations for viability to migrate to the new PortRegistry macro. Out of 12 processors analyzed:

- **‚úÖ High Priority (4)**: Simple ports, immediate migration candidates
- **‚ö†Ô∏è Medium Priority (3)**: Require minor adjustments or already partially structured
- **üî¥ Complex (3)**: Require special handling (arrays, custom structs, feature flags)
- **üìã Already Good (2)**: Have manual port structs that work well

---

## Detailed Assessment

### ‚úÖ HIGH PRIORITY - Ready for Immediate Migration

#### 1. SimplePassthroughProcessor ‚≠ê BEST CANDIDATE
**File**: `libs/streamlib/src/core/transformers/simple_passthrough.rs`

**Current Port Structure**:
```rust
pub struct SimplePassthroughProcessor {
    input: StreamInput<VideoFrame>,
    output: StreamOutput<VideoFrame>,
    // ... other fields
}
```

**Recommended Migration**:
```rust
#[port_registry]
struct SimplePassthroughPorts {
    #[input]
    input: StreamInput<VideoFrame>,

    #[output]
    output: StreamOutput<VideoFrame>,
}

pub struct SimplePassthroughProcessor {
    ports: SimplePassthroughPorts,
    scale: f32,
}
```

**Benefits**:
- **Code Reduction**: ~80 lines ‚Üí ~35 lines (56% reduction)
- **Perfect match** for migration guide example
- **Well-tested**: Has existing unit tests
- **Clean separation**: Business logic vs port management

**Migration Effort**: ‚≠ê Very Easy (2-3 hours)
- No complex dependencies
- Straightforward 1:1 port mapping
- Already has tests to verify

---

#### 2. ClapEffectProcessor ‚≠ê
**File**: `libs/streamlib/src/core/transformers/clap_effect.rs`

**Current Port Structure**:
```rust
pub struct ClapEffectInputPorts {
    pub audio: StreamInput<AudioFrame<2>>,
}

pub struct ClapEffectOutputPorts {
    pub audio: StreamOutput<AudioFrame<2>>,
}

pub struct ClapEffectProcessor {
    input_ports: ClapEffectInputPorts,
    output_ports: ClapEffectOutputPorts,
    // ... other fields
}
```

**Recommended Migration**:
```rust
#[port_registry]
struct ClapEffectPorts {
    #[input]
    audio: StreamInput<AudioFrame<2>>,

    #[output]
    audio: StreamOutput<AudioFrame<2>>,
}

pub struct ClapEffectProcessor {
    ports: ClapEffectPorts,
    config: ClapEffectConfig,
    host: Option<ClapPluginHost>,
    // ... other fields
}
```

**Benefits**:
- **Code Reduction**: ~120 lines ‚Üí ~40 lines (67% reduction)
- **Already has port structs**: Half the work done
- **Clean interface**: Ports are already separated
- **Active usage**: Used in audio-mixer-demo

**Migration Effort**: ‚≠ê Easy (3-4 hours)
- Replace existing InputPorts/OutputPorts with single macro struct
- Update accessor methods from `.input_ports.audio` to `.ports.inputs().audio`
- Update wire methods (currently manual, lines 321-345)

---

#### 3. AppleAudioOutputProcessor ‚≠ê
**File**: `libs/streamlib/src/apple/sinks/audio_output.rs`

**Current Port Structure**:
```rust
pub struct AudioOutputInputPorts {
    pub audio: StreamInput<AudioFrame<2>>,
}

pub struct AppleAudioOutputProcessor {
    input_ports: AudioOutputInputPorts,
    // ... other fields
}
```

**Recommended Migration**:
```rust
#[port_registry]
struct AppleAudioOutputPorts {
    #[input]
    audio: StreamInput<AudioFrame<2>>,
    // No #[output] - sink processor!
}

pub struct AppleAudioOutputProcessor {
    ports: AppleAudioOutputPorts,
    device_id: Option<usize>,
    stream: Option<Stream>,
    // ... other fields
}
```

**Benefits**:
- **Code Reduction**: ~100 lines ‚Üí ~30 lines (70% reduction)
- **Sink pattern**: Demonstrates zero-output processor
- **Clean interface**: Already has InputPorts struct
- **Apple-specific**: Shows macro works with platform code

**Migration Effort**: ‚≠ê Easy (2-3 hours)
- Single input port
- No complex wiring
- Already has port struct foundation

**Special Note**: Missing `get_input_port_type()` and `wire_input_connection()` - these would be auto-generated by macro!

---

#### 4. AppleDisplayProcessor ‚≠ê
**File**: `libs/streamlib/src/apple/sinks/display.rs`

**Current Port Structure**:
```rust
// Uses shared DisplayInputPorts from core
ports: DisplayInputPorts,
```

**Where DisplayInputPorts is defined** (in core):
```rust
pub struct DisplayInputPorts {
    pub video: StreamInput<VideoFrame>,
}
```

**Recommended Migration**:
```rust
#[port_registry]
struct AppleDisplayPorts {
    #[input]
    video: StreamInput<VideoFrame>,
    // No #[output] - sink processor!
}

pub struct AppleDisplayProcessor {
    ports: AppleDisplayPorts,
    window: Option<Retained<NSWindow>>,
    // ... other fields
}
```

**Benefits**:
- **Code Reduction**: ~90 lines ‚Üí ~30 lines (67% reduction)
- **Sink pattern**: Another zero-output example
- **Complex processor**: Shows macro works with Metal/AppKit code
- **Active usage**: Used in camera-display example

**Migration Effort**: ‚≠ê Easy (2-3 hours)
- Single input port
- Replace shared DisplayInputPorts with macro-generated struct
- Similar to AppleAudioOutputProcessor

**Special Note**: Currently missing wire methods - would be auto-generated!

---

### ‚ö†Ô∏è MEDIUM PRIORITY - Require Minor Adjustments

#### 5. ChordGeneratorProcessor ‚ö†Ô∏è
**File**: `libs/streamlib/src/core/sources/chord_generator.rs`

**Current Port Structure**:
```rust
pub struct ChordGeneratorOutputPorts {
    pub tone_c4: Arc<StreamOutput<AudioFrame<1>>>,
    pub tone_e4: Arc<StreamOutput<AudioFrame<1>>>,
    pub tone_g4: Arc<StreamOutput<AudioFrame<1>>>,
}
```

**Challenge**: Uses `Arc<StreamOutput<T>>` instead of `StreamOutput<T>`

**Option 1 - Modify to work with macro** (Recommended):
```rust
#[port_registry]
struct ChordGeneratorPorts {
    // No #[input] - source processor!

    #[output]
    tone_c4: StreamOutput<AudioFrame<1>>,

    #[output]
    tone_e4: StreamOutput<AudioFrame<1>>,

    #[output]
    tone_g4: StreamOutput<AudioFrame<1>>,
}
```

**Required Changes**:
- Remove `Arc<>` wrapper from port definitions
- Update `Arc::clone(&self.output_ports.tone_c4)` to `Arc::new(self.ports.outputs().tone_c4.clone())`
- Update thread spawning logic (lines 204-206)

**Option 2 - Keep as-is**:
The current manual implementation works fine for this multi-output source processor.

**Benefits of Migration**:
- **Code Reduction**: ~120 lines ‚Üí ~50 lines (58% reduction)
- **Source pattern**: Demonstrates zero-input processor
- **Multi-output**: Shows macro handles multiple outputs

**Migration Effort**: ‚ö†Ô∏è Medium (4-6 hours)
- Requires Arc wrapper adjustments
- Complex threading logic needs careful testing
- Multiple output ports to wire

**Recommendation**: Medium priority - wait for simpler processors first, then use this as test case for multi-output pattern.

---

#### 6. AppleCameraProcessor ‚ö†Ô∏è
**File**: `libs/streamlib/src/apple/sources/camera.rs`

**Current Port Structure**:
```rust
// Uses shared CameraOutputPorts from core
ports: CameraOutputPorts,
```

**Where CameraOutputPorts is defined** (in core):
```rust
pub struct CameraOutputPorts {
    pub video: StreamOutput<VideoFrame>,
}
```

**Recommended Migration**:
```rust
#[port_registry]
struct AppleCameraPorts {
    // No #[input] - source processor!

    #[output]
    video: StreamOutput<VideoFrame>,
}

pub struct AppleCameraProcessor {
    ports: AppleCameraPorts,
    device_id: Option<String>,
    // ... many other fields ...
}
```

**Benefits**:
- **Code Reduction**: ~100 lines ‚Üí ~30 lines (70% reduction)
- **Source pattern**: Another zero-input example
- **Complex integration**: Shows macro works with AVFoundation

**Challenges**:
- Very complex initialization (AVFoundation, Metal, delegates)
- Frame callback through static OnceLock
- Integration with WgpuBridge

**Migration Effort**: ‚ö†Ô∏è Medium (4-6 hours)
- Simple port structure BUT complex surrounding code
- Needs careful testing with hardware
- Risk of breaking camera capture

**Recommendation**: Medium priority - migrate after SimplePassthrough and ClapEffect proven working.

---

### üî¥ COMPLEX - Special Handling Required

#### 7. PerformanceOverlayProcessor üî¥
**File**: `libs/streamlib/src/core/transformers/performance_overlay.rs`

**Current Port Structure**:
```rust
#[cfg(feature = "debug-overlay")]
pub struct PerformanceOverlayInputPorts {
    pub video: StreamInput<VideoFrame>,
}

#[cfg(feature = "debug-overlay")]
pub struct PerformanceOverlayOutputPorts {
    pub video: StreamOutput<VideoFrame>,
}
```

**Challenge**: Entire processor is `#[cfg(feature = "debug-overlay")]`

**Recommended Migration**:
```rust
#[cfg(feature = "debug-overlay")]
#[port_registry]
struct PerformanceOverlayPorts {
    #[input]
    video: StreamInput<VideoFrame>,

    #[output]
    video: StreamOutput<VideoFrame>,
}
```

**Benefits**:
- **Code Reduction**: ~150 lines ‚Üí ~50 lines (67% reduction)
- **Debug tool**: Useful for performance monitoring
- **Video passthrough**: Similar to SimplePassthrough

**Challenges**:
- **Feature flag complexity**: Macro must work with cfg
- **Vello/GPU integration**: Heavy GPU processing code
- **Optional profiler**: wgpu_profiler conditionally compiled

**Migration Effort**: üî¥ Complex (6-8 hours)
- Need to test macro with feature flags
- Verify Vello rendering still works
- GPU profiler integration must be preserved

**Recommendation**: Low priority - feature-flagged debugging tool, not critical path. Migrate after all core processors working.

---

#### 8. AudioMixerProcessor<const N: usize> üî¥
**File**: `libs/streamlib/src/core/transformers/audio_mixer.rs`

**Current Port Structure**:
```rust
pub struct AudioMixerProcessor<const N: usize> {
    pub input_ports: [StreamInput<AudioFrame<1>>; N],
    pub output_ports: AudioMixerOutputPorts,
}

pub struct AudioMixerOutputPorts {
    pub audio: StreamOutput<AudioFrame<2>>,
}
```

**Challenge**: Uses **array of ports** with const generic `N`

**Current Macro Limitation**: PortRegistry macro doesn't support array fields

**Option 1 - Enhance macro** (Future work):
```rust
#[port_registry]
struct AudioMixerPorts<const N: usize> {
    #[input(count = N)]
    inputs: [StreamInput<AudioFrame<1>>; N],

    #[output]
    audio: StreamOutput<AudioFrame<2>>,
}
```

**Option 2 - Hybrid approach** (Recommended for now):
```rust
#[port_registry]
struct AudioMixerOutputPortsOnly {
    #[output]
    audio: StreamOutput<AudioFrame<2>>,
}

pub struct AudioMixerProcessor<const N: usize> {
    // Keep array of inputs manual
    pub input_ports: [StreamInput<AudioFrame<1>>; N],

    // Use macro for output
    output_ports: AudioMixerOutputPortsOnly,
}
```

**Option 3 - Keep as-is** (Current recommendation):
The current implementation is clean and the array handling is justified.

**Migration Effort**: üî¥ Very Complex (8-12 hours OR macro enhancement)
- Requires macro enhancement for array support
- Alternative: Keep manual for inputs, use macro for output only
- Complex wiring logic (lines 245-260)

**Recommendation**: **Do NOT migrate** until macro has array support. Current implementation is good.

---

### üìã ALREADY WELL-STRUCTURED

These processors have clean manual implementations that don't benefit significantly from migration:

#### 9-12. Core/Apple Source/Sink Placeholders üìã

The following are either placeholders or use the already-clean manual structs:
- `libs/streamlib/src/core/sources/audio_capture.rs` - Platform abstraction
- `libs/streamlib/src/core/sources/camera.rs` - Platform abstraction
- `libs/streamlib/src/core/sinks/audio_output.rs` - Platform abstraction
- `libs/streamlib/src/core/sinks/display.rs` - Platform abstraction

These are thin wrappers that delegate to platform-specific implementations (Apple/Linux/Windows).

---

## Migration Priority Ranking

### Phase 1: Prove the Concept (Week 1)
1. **SimplePassthroughProcessor** ‚≠ê‚≠ê‚≠ê
   - Easiest migration
   - Perfect example for migration guide
   - Has tests to verify

2. **ClapEffectProcessor** ‚≠ê‚≠ê‚≠ê
   - Used in active examples
   - Already has port structs
   - Demonstrates audio processing

### Phase 2: Platform Support (Week 2)
3. **AppleAudioOutputProcessor** ‚≠ê‚≠ê
   - Sink pattern
   - Platform-specific code

4. **AppleDisplayProcessor** ‚≠ê‚≠ê
   - Sink pattern
   - Complex Metal integration

### Phase 3: Multi-Output Sources (Week 3)
5. **AppleCameraProcessor** ‚ö†Ô∏è
   - Source pattern
   - Hardware integration

6. **ChordGeneratorProcessor** ‚ö†Ô∏è
   - Multi-output source
   - Requires Arc adjustments

### Phase 4: Special Cases (Week 4+)
7. **PerformanceOverlayProcessor** üî¥
   - Feature-flagged
   - Debug tooling

8. **AudioMixerProcessor** üî¥
   - **Hold** - Requires macro enhancement for arrays

---

## Code Impact Analysis

### Expected Code Reduction by Processor

| Processor | Current LOC | Expected LOC | Reduction | Priority |
|-----------|-------------|--------------|-----------|----------|
| SimplePassthrough | ~210 | ~130 | 38% | ‚úÖ High |
| ClapEffect | ~350 | ~230 | 34% | ‚úÖ High |
| AppleAudioOutput | ~200 | ~130 | 35% | ‚úÖ High |
| AppleDisplay | ~400 | ~310 | 23% | ‚úÖ High |
| ChordGenerator | ~365 | ~245 | 33% | ‚ö†Ô∏è Medium |
| AppleCamera | ~500 | ~400 | 20% | ‚ö†Ô∏è Medium |
| PerformanceOverlay | ~900 | ~750 | 17% | üî¥ Complex |
| AudioMixer<N> | ~262 | ~262 | 0% | üî¥ Keep As-Is |
| **TOTAL** | **~3,187** | **~2,457** | **~23%** | |

**Total Potential Reduction**: ~730 lines across viable processors

---

## Macro Enhancements Needed

### Current Blockers

1. **Array Support** (AudioMixerProcessor):
   ```rust
   #[port_registry]
   struct ProcessorPorts<const N: usize> {
       #[input(count = N)]
       inputs: [StreamInput<T>; N],
   }
   ```

2. **Arc<StreamOutput<T>> Support** (ChordGeneratorProcessor):
   Currently requires manual `Arc<>` wrapper for thread safety

3. **Feature Flag Compatibility** (PerformanceOverlayProcessor):
   Macro must work correctly inside `#[cfg(feature = "...")]`

### Future Enhancements

4. **Conditional Ports**:
   ```rust
   #[port_registry]
   struct ProcessorPorts {
       #[input(required = false)]
       optional_input: StreamInput<T>,
   }
   ```

5. **Port Metadata from Attributes**:
   ```rust
   #[input(description = "Primary video input", required = true)]
   video: StreamInput<VideoFrame>,
   ```

---

## Testing Strategy

### Per-Processor Validation

For each migrated processor:

1. **Compilation** ‚úÖ
   - Verify code compiles without errors
   - Check generated code with `cargo expand`

2. **Unit Tests** ‚úÖ
   - Run existing processor unit tests
   - Add new tests for port introspection

3. **Integration Tests** ‚úÖ
   - Run processor in example pipelines
   - Verify connections work correctly

4. **Behavioral Tests** ‚úÖ
   - Compare output with pre-migration baseline
   - Ensure no functional regressions

### Example-Based Testing

Update examples to use migrated processors:
- `simple-pipeline` - Uses SimplePassthrough
- `audio-mixer-demo` - Uses ClapEffect
- `camera-display` - Uses AppleDisplay + AppleCamera

---

## Risk Assessment

### Low Risk ‚úÖ
- **SimplePassthroughProcessor**: Well-tested, simple structure
- **ClapEffectProcessor**: Already has port structs, active usage
- **AppleAudioOutputProcessor**: Single input, straightforward

### Medium Risk ‚ö†Ô∏è
- **AppleDisplayProcessor**: Complex Metal integration
- **ChordGeneratorProcessor**: Multi-output, Arc wrappers
- **AppleCameraProcessor**: Hardware dependencies, AVFoundation

### High Risk üî¥
- **PerformanceOverlayProcessor**: Feature flags, GPU profiling
- **AudioMixerProcessor**: Const generics, array ports

---

## Recommendations

### Immediate Actions (This Week)

1. ‚úÖ **Migrate SimplePassthroughProcessor**
   - Use as reference implementation
   - Update migration guide with actual code
   - Validate macro functionality

2. ‚úÖ **Migrate ClapEffectProcessor**
   - Prove macro works with active audio code
   - Test in audio-mixer-demo example

3. ‚úÖ **Create Migration Validation Checklist**
   - Document steps for each processor
   - Create before/after comparison template

### Next Steps (Week 2-3)

4. ‚ö†Ô∏è **Migrate Apple Sinks**
   - AppleAudioOutputProcessor
   - AppleDisplayProcessor
   - Test with platform-specific examples

5. ‚ö†Ô∏è **Migrate Sources**
   - AppleCameraProcessor
   - ChordGeneratorProcessor
   - Handle multi-output pattern

### Future Work (Week 4+)

6. üî¥ **Evaluate Macro Enhancements**
   - Array support for AudioMixerProcessor
   - Arc<> wrapper support
   - Feature flag compatibility

7. üìã **Update All Examples**
   - Ensure examples use migrated processors
   - Update documentation
   - Add migration guide examples

### Do NOT Migrate

- **AudioMixerProcessor<N>** - Requires macro enhancement
- Current array-based implementation is clean and appropriate

---

## Success Metrics

### Code Quality
- ‚úÖ All migrated processors compile
- ‚úÖ No increase in warnings
- ‚úÖ Generated code is readable (cargo expand)

### Functionality
- ‚úÖ All existing tests pass
- ‚úÖ Examples run correctly
- ‚úÖ No behavioral regressions

### Maintainability
- ‚úÖ Port changes require fewer edits
- ‚úÖ Consistent accessor pattern (`.inputs()` / `.outputs()`)
- ‚úÖ Reduced boilerplate per processor

### Documentation
- ‚úÖ Migration guide updated with real examples
- ‚úÖ Before/after comparisons for each processor
- ‚úÖ Known issues documented

---

## Conclusion

**Ready for Migration**: 6 processors (Simple ‚Üí Medium complexity)
**Requires Work**: 2 processors (Special handling needed)
**Keep As-Is**: 1 processor (AudioMixer - needs macro enhancement)

**Total Expected Impact**:
- ~730 lines of code reduction
- 23% reduction in processor boilerplate
- Improved maintainability across all migrated processors
- Consistent port access patterns

**Recommended Approach**: Incremental migration starting with SimplePassthroughProcessor and ClapEffectProcessor to validate the macro, then progressively tackle more complex processors.

**Timeline Estimate**: 3-4 weeks for full migration of viable processors.
