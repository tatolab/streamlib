# Lefthook configuration for StreamLib
# https://github.com/evilmartians/lefthook

pre-commit:
  parallel: true
  commands:
    format:
      glob: "*.rs"
      run: cargo fmt --all -- --check
      stage_fixed: true

    cargo-check:
      glob: "*.rs"
      run: cargo check --workspace --all-features

pre-push:
  parallel: false # Run sequentially to see errors in order
  commands:
    # 0. License check - ensure all Rust files have copyright header
    # Excludes: proto/ (generated by prost-build)
    license-check:
      run: |
        missing_files=()
        for file in $(find libs -name "*.rs" -type f | grep -v '/proto/'); do
          if ! head -2 "$file" | grep -q "Copyright (c) 2025 Jonathan Fontanez"; then
            missing_files+=("$file")
          fi
        done
        if [ ${#missing_files[@]} -ne 0 ]; then
          echo "‚ùå The following files are missing the required copyright header:"
          echo ""
          for f in "${missing_files[@]}"; do
            echo "  - $f"
          done
          echo ""
          echo "Required header (first two lines of file):"
          echo "  // Copyright (c) 2025 Jonathan Fontanez"
          echo "  // SPDX-License-Identifier: BUSL-1.1"
          exit 1
        fi

    # 1. Fast check - ensure code compiles
    check:
      run: cargo check --workspace --all-features

    # 2. Linting - catch code quality issues
    clippy:
      run: cargo clippy --workspace --all-features --bins --lib -- -D warnings

    # 3. Tests - ensure functionality works
    # Note: streamlib-python excluded because PyO3 tests require Python linking
    test-lib:
      run: cargo test --workspace --all-features --lib --exclude streamlib-python

    # 4. Example builds - ensure examples still compile
    test-examples:
      run: |
        cargo build -p api-server
        cargo build -p tokio-integration

# Skip hooks with LEFTHOOK=0 environment variable
# Example: LEFTHOOK=0 git push
